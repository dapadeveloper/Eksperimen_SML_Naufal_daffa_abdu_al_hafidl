name: banknote_authentication

on:
  push:
    branches: [ main, master ]
    paths:
      - 'namadataset_raw/**'
      - 'preprocessing/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.9'

jobs:
  preprocess-and-train:
    name: Preprocess & Train Banknote Authentication
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create preprocessing folder
      run: |
        mkdir -p preprocessing/namadataset_preprocessing

    - name: Verify dataset exists
      run: |
        echo "Checking dataset files..."
        if [ -f "namadataset_raw/banknote_authentication.csv" ]; then
          echo "Dataset found"
          wc -l namadataset_raw/banknote_authentication.csv
        else
          echo "Dataset file not found!"
          exit 1
        fi

    - name: Run automate_naufal.py (preprocess & train)
      run: |
        cd preprocessing
        python automate_naufal.py --train
        echo "Preprocessing and training completed"

    - name: Verify processed data
      run: |
        echo "Processed files in preprocessing/namadataset_preprocessing/:"
        ls -la preprocessing/namadataset_preprocessing/
        for file in preprocessing/namadataset_preprocessing/*; do
          if [ -f "$file" ]; then
            echo "File: $file - Lines: $(wc -l < "$file")"
          fi
        done

    - name: Commit processed data if changes exist
      run: |
        chmod +x preprocessing/commit_preprocessed.sh
        ./preprocessing/commit_preprocessed.sh

    - name: Upload processed data as artifact
      uses: actions/upload-artifact@v4
      with:
        name: processed-banknote-data
        path: preprocessing/namadataset_preprocessing/
        retention-days: 30