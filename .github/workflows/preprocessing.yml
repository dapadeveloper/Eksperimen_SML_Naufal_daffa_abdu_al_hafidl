name: preprocessing-pipeline

on:
  push:
    branches: [ main, master ]
    paths:
      - 'namadataset_raw/**'
      - 'preprocessing/**'
      - '.workflow/**'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.9'

jobs:
  preprocess:
    name: Run Preprocessing Pipeline
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install Requirements
      run: |
        pip install pandas

    - name: Verify dataset exists
      run: |
        echo "Checking dataset file..."
        if [ -f "namadataset_raw/banknote_authentication.csv" ]; then
          echo "Dataset found."
          wc -l namadataset_raw/banknote_authentication.csv
        else
          echo "Dataset missing! Please upload raw dataset to namadataset_raw/"
          exit 1
        fi

    - name: Run automate preprocessing
      run: |
        cd preprocessing
        python automate_naufal.py --run

    - name: Show preprocessing output
      run: |
        echo "Generated files:"
        ls -lah preprocessing/namadataset_preprocessing/

    - name: Commit changes if any
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "github-actions@github.com"

        git add preprocessing/namadataset_preprocessing/*

        if git diff --cached --quiet; then
          echo "No changes to commit."
        else
          git commit -m "Auto-update preprocessed dataset [CI]"
          git push
        fi

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: preprocessed-banknote-data
        path: preprocessing/namadataset_preprocessing/
        retention-days: 7